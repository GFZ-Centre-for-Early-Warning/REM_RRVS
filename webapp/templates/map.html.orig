<!DOCTYPE html>
<<<<<<< HEAD
<html style=""><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
	<title>RRVS Map</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="../static/leaflet/leaflet.css">
=======
<html>
<head>
	<title>RRVS Webtool - Map</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
>>>>>>> devmarc
	<link rel="stylesheet" type="text/css" href="../static/css/main.css">
	<link rel="stylesheet" href="../static/leaflet/leaflet.css">
	<script src="../static/leaflet/leaflet.js"></script>
<<<<<<< HEAD
	<script src="../static/leaflet-knn.js"></script>
=======
>>>>>>> devmarc
</head>
<body>
	<div id="map"></div>	
	<script>
		//add map object
		var map = L.map('map');
		
		//define layer variables
		var gpsJSON;
		var buildingsJSON;
	
		//add baselayer
		var basemap = L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Processing &copy; <a href="http://www.gfz-potsdam.de/en/section/ews/">GFZ Potsdam - Centre for Early Warning Systems</a>' +
						 ' | Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>, ',
			subdomains: ['otile1','otile2','otile3','otile4']
		}).addTo(map);

		//function for dynamic building polygon style
		function building_style(feature) {
			return {
				fillColor: '#66ccff',
				fillOpacity: 0.6,
				weight: 1,
                opacity: 1,
                color: '#afafaf'
			};
		}
		
		function highlightBuilding(e) {
			var layer = e.target;
			layer.setStyle({
				//fillColor: '#ff0000',
				//fillOpacity: 0.6,
				weight: 1,
                opacity: 1,
                color: '#afafaf'
			});
			if (!L.Browser.ie && !L.Browser.opera) {
				layer.bringToFront();
			}
		}
		
		function resetHighlightBuilding() {
			buildingsJSON.resetStyle(buildingsJSON);
		}
		
		//variable for dynamic gps point layer style and get-feature-info
		var gpsDefaultStyle = {
				radius: 4,
				fillColor: '#0B0B3B',
				color: '#0B0B3B',
				opacity: 0.8,
				fillOpacity: 0.6
		}		

        //variable with highlighted GPS img marker style
        var gpsHighlightStyle = {
				radius: 8,
				fillColor: '#0B0B3B',
				color: '#2E9AFE',
				opacity: 1,
				fillOpacity: 0.6
        }

        //variable to keep track of highlighted gps img marker
        var highlightedGPS = null;

	    //function removing highlight from GPS image marker if set
		function resetHighlightGPS() {
            if (highlightedGPS != null){
                highlightedGPS.setStyle(gpsDefaultStyle);
                highlightedGPS = null;
            }
		}
        
        //object to keep gps location, azimuth of selected image and location of selected bdg
        var imgBdgData = Object.create(null);

        //object to keep panoramic image configuration
        var configPano = new Object();
        configPano.autoLoad=true;

        //update image related parameters
        function updateImgParams(e){
            //update imgBdgData object
            console.log(e);
            console.log(highlightedGPS);
            imgBdgData.imgLoc = e.getLatLng();
            imgBdgData.imgAzi = e.feature.properties.azimuth;
            imgBdgData.img_id = e.feature.properties.img_id;
            console.log(imgBdgData);
            //update configPano
            configPano.panorama = "/panellum/../static/panoimg/ladybug_panoramic_" + imgBdgData.img_id + ".jpg";
            configPano.title = "FrameID: " + imgBdgData.img_id;
        }
        
		//function for interaction between gps layer and panoImg iframe
		function updatePanoImg() {
			// zoom to feature in map
			map.fitBounds(highlightedGPS.getBounds(), {maxZoom: 17});
			// update src of iframe 1 (panoImg)
            // distinguish between frame mode or multi window mode
            if(self==top){
			    var ifrm = opener.document.getElementById('ifrm1');
            }else{
			    var ifrm = parent.document.getElementById('ifrm1');
            }
            //convert json to URI
            var config_json = JSON.stringify(configPano);
            config_json = encodeURIComponent(config_json);
            //reset panellum image source
            ifrm.src = "{{ url_for('pannellum') }}?config="+config_json;
		}

        //function to calculate angle between two points in degrees p1 to p2
        var angleDeg = function (p1,p2){
            return Math.atan2(p2.lat - p1.lat, p2.lng - p1.lng) * 180 / Math.PI;
        }

<<<<<<< HEAD
        // function to calculate image building location parameters
        function imgBdgInteraction(){
            var ang = angleDeg(imgBdgData.imgLoc,imgBdgData.bdgLoc);
            configPano.yaw = (90-ang)-imgBdgData.imgAzi;
            configPano.hotSpots = [{pitch:'0',yaw:configPano.yaw,type:'info',text:'Selected building'}];
=======
        //function for interaction between building layer and panoImg iframe 
        //updates yaw of panoImg wrt clicked building location
        function updatePanoImgYaw(e){
            //get centroid of the selected building
            var bdg_centroid = e.latlng;
            var img_pos = imgData.loc;
            //get angle between the two points
            var ang = angleDeg(img_pos,bdg_centroid);
            //add to azimuth of img
            var azi = imgData.azi;
            var yaw_val=(90-ang)-azi;
            //update image yaw
            var ifrm = parent.document.getElementById('ifrm1');
            var src = ifrm.src+"&yaw="+String(yaw_val);
            ifrm.src = src.replace(/%26/g, "&amp;");
>>>>>>> devmarc
        }

		//function for interaction between building layer, rrvsForm iframe and the pannellum iframe
		function updateForm(e) {
			// update content of iframe 3 (rrvsForm)
			var ifrm = parent.document.getElementById('ifrm3');
			var doc = ifrm.contentDocument? ifrm.contentDocument: ifrm.contentWindow.document;
			doc.forms['rrvsForm'].elements['gid_field'].focus();	// focus in and out of the gid_field is needed by rrvsform.html to trigger the form update function (on focusout)
			doc.forms['rrvsForm'].elements['gid_field'].value = e.target.feature.properties.gid;
			doc.forms['rrvsForm'].elements['height_field'].focus();	
			// update building map styles
			resetHighlightBuilding();
			highlightBuilding(e);
            //store the building location
            imgBdgData.bdgLoc=e.latlng;
            // update panoramic image
            // find closest img 
            //var closestImg = L.GeometryUtil.closestLayer(map, [gpsJSON], imgBdgData.bdgLoc);
            var closestImg = leafletKnn(gpsJSON).nearestLayer(imgBdgData.bdgLoc,1);
            closestImg = closestImg[0].layer;
            //highlight this feature
            resetHighlightGPS();
            closestImg.setStyle(gpsHighlightStyle);
            highlightedGPS=closestImg;
            //set configPano and imgBdgData accordingly
            updateImgParams(closestImg);
            imgBdgInteraction();
            //update the image
            updatePanoImg();
		}
        
        //function to highlight clicked img and update panellum frame
        function clickedImg(e){
		    resetHighlightGPS(); 
            e.target.setStyle(gpsHighlightStyle);
            highlightedGPS=e.target;
            //update the image related parameters
            updateImgParams(highlightedGPS);
            //In case a building was selected before calculate yaw
            if(imgBdgData.bdgLoc != undefined){
                imgBdgInteraction();
            }
            updatePanoImg();
        }

		//function for adding actions to mouse events on gps layer
		function onEachFeatureGps(feature, layer) {
			layer.on({
                click: clickedImg
			});
		}
		
		//function for adding actions to mouse events on buildings layer
		function onEachFeatureBuilding(feature, layer) {
			layer.on({
				click: updateForm
			});
		}
		
		//add gps layer
gpsJSON = L.geoJson({{gps|safe}},{
			style: gpsDefaultStyle,
			onEachFeature: onEachFeatureGps,
			pointToLayer: function (feature, latlng) {  
				return L.circleMarker(latlng)
				}
			});	
		gpsJSON.addTo(map);
		
		//add buildings layer
        buildingsJSON = L.geoJson({{bdgs|safe}},{
            style: building_style,
            onEachFeature: onEachFeatureBuilding
            });
		buildingsJSON.addTo(map);
		
		//focus map on layer extent
		map.fitBounds(gpsJSON.getBounds());
		
		//control that shows info on hover
		var info = L.control();
		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'info');
			this.update();
			return this._div;
		};
		info.update = function (props) {
			this._div.innerHTML = (props ?
				'<b>FrameID: ' + props.img_id + '</b><br/>Azimuth: ' + props.azimuth + '</sup>'
				: 'PanoImage Information');
		};
		info.addTo(map);

		//add layer control
		L.control.layers({'OpenStreetMap': basemap},
						 {"PanoImages": gpsJSON,
						 "Buildings": buildingsJSON},
						 {collapsed:true}).addTo(map);
		
		//add scale
		L.control.scale({options: {position: 'bottomleft',maxWidth: 100,metric: true,imperial: false,updateWhenIdle: false}}).addTo(map);
	</script>
</body>
</html>
